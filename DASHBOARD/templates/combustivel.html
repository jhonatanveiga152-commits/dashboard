<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>JR Dashboard - Combust&iacute;vel</title>
  <link rel="icon" href="{{ url_for('static', filename='logo-jr.png') }}">
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js" defer></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img src="{{ url_for('static', filename='logo-jr.png') }}" alt="JR" class="logo">
      <h1>JR DASHBOARD &bull; Combust&iacute;vel</h1>
    </div>
    <div class="filters">
      <select id="mes"></select>
      <select id="placa"></select>
      <select id="posto"></select>
      <select id="combustivel"></select>
      <button id="limpar">Limpar filtros</button>
      <a href="{{ url_for('home') }}" class="back-btn">&larr; Voltar</a>
    </div>
  </header>

  <main class="container">
    <section class="kpis">
      <div class="kpi red">
        <div class="kpi-title">Total (R$)</div>
        <div id="kpi-custo" class="kpi-value">--</div>
      </div>
      <div class="kpi blue">
        <div class="kpi-title">KM total</div>
        <div id="kpi-km" class="kpi-value">--</div>
      </div>
      <div class="kpi yellow">
        <div class="kpi-title">Total litros</div>
        <div id="kpi-litros" class="kpi-value">--</div>
      </div>
      <div class="kpi green">
        <div class="kpi-title">Custo m&eacute;dio por KM</div>
        <div id="kpi-custo-km" class="kpi-value">--</div>
      </div>
      <div class="kpi green">
        <div class="kpi-title">M&eacute;dia KM/L</div>
        <div id="kpi-km-litro" class="kpi-value">--</div>
      </div>
      <div class="kpi green">
        <div class="kpi-title">Custo m&eacute;dio por litro</div>
        <div id="kpi-custo-litro" class="kpi-value">--</div>
      </div>
    </section>

    <section class="grid">
      <div class="card"><h2>Gasto total por m&ecirc;s</h2><div id="chart-custo-mes"></div></div>
      <div class="card"><h2>Gasto por posto</h2><div id="chart-posto"></div></div>
      <div class="card"><h2>Gasto por combust&iacute;vel</h2><div id="chart-comb"></div></div>
      <div class="card"><h2>KM por m&ecirc;s</h2><div id="chart-km-mes"></div></div>
      <div class="card"><h2>Litros por m&ecirc;s</h2><div id="chart-litros-mes"></div></div>
    </section>
  </main>

  <footer class="footer">
    Atualizado automaticamente a partir da planilha em <code>data/combustivel.xlsx</code>. &copy; JR
  </footer>

<script>
const fmtBRL = (value) => Number(value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
const fmtNum = (value) => Number(value || 0).toLocaleString('pt-BR');
const safeArray = (source, key) => (source && Array.isArray(source[key])) ? source[key] : [];

async function fetchData() {
  const params = new URLSearchParams({
    mes: document.getElementById('mes').value || 'Todos',
    placa: document.getElementById('placa').value || 'Todos',
    posto: document.getElementById('posto').value || 'Todos',
    combustivel: document.getElementById('combustivel').value || 'Todos'
  });
  const res = await fetch('/data/combustivel?' + params.toString());
  return await res.json();
}

function fillSelect(id, values, label) {
  const el = document.getElementById(id);
  const current = el.value;
  el.innerHTML = '';
  const optAll = document.createElement('option');
  optAll.value = 'Todos';
  optAll.textContent = `${label} (Todos)`;
  el.appendChild(optAll);
  (values || []).forEach((value) => {
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = value;
    el.appendChild(opt);
  });
  if ([...el.options].some((option) => option.value === current)) {
    el.value = current;
  }
}

function drawBarVertical(divId, x, y) {
  const data = [{ type: 'bar', x: x || [], y: y || [] }];
  const layout = { margin: { l: 50, r: 20, t: 10, b: 60 }, xaxis: { tickangle: -20 }, hovermode: 'closest' };
  Plotly.newPlot(divId, data, { ...plotlyTheme.layout, ...layout }, plotlyTheme.config);
}

function drawPie(divId, labels, values) {
  const data = [{ type: 'pie', labels: labels || [], values: values || [], hole: 0.45 }];
  const layout = { margin: { l: 20, r: 20, t: 10, b: 10 } };
  Plotly.newPlot(divId, data, { ...plotlyTheme.layout, ...layout }, plotlyTheme.config);
}

async function refresh() {
  const d = await fetchData();

  if (!refresh._init) {
    fillSelect('mes', d.meses, 'M&ecirc;s');
    fillSelect('placa', d.placas, 'Placa');
    fillSelect('posto', d.postos, 'Posto');
    fillSelect('combustivel', d.combustiveis, 'Combust&iacute;vel');
    ['mes', 'placa', 'posto', 'combustivel'].forEach((id) => {
      document.getElementById(id).addEventListener('change', refresh);
    });
    document.getElementById('limpar').addEventListener('click', () => {
      ['mes', 'placa', 'posto', 'combustivel'].forEach((id) => {
        document.getElementById(id).value = 'Todos';
      });
      refresh();
    });
    refresh._init = true;
  }

  document.getElementById('kpi-custo').textContent = fmtBRL(d.custo_total);
  document.getElementById('kpi-km').textContent = fmtNum(d.km_total);
  document.getElementById('kpi-litros').textContent = fmtNum(d.litros_total);
  document.getElementById('kpi-custo-km').textContent = 'R$ ' + Number(d.custo_por_km || 0).toFixed(2);
  document.getElementById('kpi-km-litro').textContent = `${Number(d.km_por_litro || 0).toFixed(2)} km/L`;
  document.getElementById('kpi-custo-litro').textContent = 'R$ ' + Number(d.custo_por_litro || 0).toFixed(2);

  const meses = safeArray(d.custo_mensal, 'Mes');
  const custos = safeArray(d.custo_mensal, 'Custo');

  const traceLine = {
    type: 'scatter',
    mode: 'lines+markers',
    x: meses,
    y: custos,
    line: { color: '#1C2D6B', width: 3 },
    marker: { size: 7, color: '#BE1E2D' },
    hovertemplate: '<b>%{x}</b><br>R$ %{y:,.2f}<extra></extra>'
  };

  const layoutCusto = {
    margin: { l: 60, r: 20, t: 40, b: 60 },
    xaxis: { tickangle: -30 },
    yaxis: { title: 'R$' },
    hovermode: 'x unified'
  };

  Plotly.newPlot('chart-custo-mes', [traceLine], { ...plotlyTheme.layout, ...layoutCusto }, plotlyTheme.config);

  drawPie('chart-posto', safeArray(d.gasto_por_posto, 'POSTOS'), safeArray(d.gasto_por_posto, 'Custo'));
  drawPie('chart-comb', safeArray(d.gasto_por_combustivel, 'Combustivel'), safeArray(d.gasto_por_combustivel, 'Custo'));
  drawBarVertical('chart-km-mes', safeArray(d.km_mensal, 'Mes'), safeArray(d.km_mensal, 'Km Rodados'));
  drawBarVertical('chart-litros-mes', safeArray(d.litros_mensal, 'Mes'), safeArray(d.litros_mensal, 'Litros'));
}

const plotlyTheme = {
  layout: {
    paper_bgcolor: '#fff',
    plot_bgcolor: '#fff',
    font: { family: 'Inter, sans-serif', color: '#1C2D6B' },
    xaxis: { gridcolor: '#e5e7eb', zerolinecolor: '#e5e7eb', linecolor: '#e5e7eb' },
    yaxis: { gridcolor: '#e5e7eb', zerolinecolor: '#e5e7eb', linecolor: '#e5e7eb' },
    colorway: ['#1C2D6B', '#BE1E2D', '#4B5563', '#9CA3AF']
  },
  config: {
    responsive: true,
    displaylogo: false,
    modeBarButtonsToRemove: ['lasso2d', 'select2d']
  }
};

window.addEventListener('DOMContentLoaded', refresh);
</script>
</body>
</html>
